<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Kanjeng Production</title>
  
  <!-- ğŸ¨ MODULAR CSS (3 Files) -->
  <link rel="stylesheet" href="/css/style.css">

  
  <!-- ğŸ”” SweetAlert2 for Beautiful Modals -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
  <div class="login-container">
    <!-- ğŸ“ Top Gold Bar -->
    <div class="top-bar"></div>
    
    <!-- ğŸ–¼ï¸ Logo -->
    <div class="logo">
      <img id="main_logo" src="https://ui-avatars.com/api/?name=Admin&background=0f172a&color=fff" alt="Logo">
    </div>
    
    <!-- ğŸ“ Title -->
    <h1>ğŸ” Secure Login</h1>
    <p class="subtitle">Kanjeng Production Management</p>
    
    <!-- âš ï¸ Alert Message -->
    <div id="alertMessage"></div>
    
    <!-- ğŸ“‹ Login Form -->
    <form id="loginForm">
      <input 
        type="text" 
        id="login_id" 
        name="login_id" 
        placeholder="Username atau Email" 
        required 
        style="margin-bottom: 20px;"
      >
      
      <input 
        type="password" 
        id="password" 
        name="password" 
        placeholder="Password" 
        required 
        style="margin-bottom: 25px;"
      >
      
      <button type="submit" class="btn" id="btnLogin">MASUK SEKARANG</button>
      <div class="spinner" id="loadingSpinner"></div>
    </form>
    
    <!-- ğŸ”— Register Link -->
    <div class="register-link">
      Belum punya akun? <a href="/registrasi" target="_top">Daftar Sultan</a>
    </div>
    
    <!-- ğŸ”‘ Forgot Password/Pin Links -->
    <div class="register-link" style="margin-top: 8px;">
      <a href="https://untungbersama.us/?page=forgot-password" target="_top">Lupa Password</a>
      <span>/</span>
      <a href="https://untungbersama.us/?page=forgot-pin" target="_top">Lupa Pin</a>
    </div>
  </div>

  <!-- ğŸ“œ JAVASCRIPT -->
  <script>
    // ================================
    // CONFIG
    // ================================
    const API_URL = "https://untungbersama.us";
    let isSubmitting = false;

    console.log('ğŸš€ Sultan Login System - Cloudflare Version Loaded');

    // --- ğŸ›¡ï¸ GLOBAL ERROR CATCHER ---
    window.addEventListener('error', function(e) {
      console.error('âŒ GLOBAL ERROR:', e.message);
    });

    // --- ğŸ¯ AUTO-BIND FORM SAAT DOM READY ---
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ğŸ“‹ DOM Ready - Auto-binding form...');
      
      const loginForm = document.getElementById('loginForm');
      if (loginForm) {
        console.log('âœ… Form found, binding submit event...');
        
        loginForm.onsubmit = function(e) {
          e.preventDefault();
          e.stopPropagation();
          return handleLogin(e);
        };
        
        loginForm.addEventListener('submit', function(e) {
          e.preventDefault();
          e.stopPropagation();
          handleLogin(e);
          return false;
        });
        
        const btn = document.getElementById('btnLogin');
        if (btn) {
          btn.onclick = function(e) {
            e.preventDefault();
            handleLogin(e);
            return false;
          };
        }
      }
    });

    /**
     * ğŸ† SULTAN MODAL ENGINE (SweetAlert2)
     */
    function showSultanModal(title, message, type) {
      console.log('ğŸ”” Showing modal:', type, '-', title);
      const isError = type === 'error';
      
      Swal.fire({
        icon: isError ? 'error' : 'success',
        title: `<div style="font-size: 18px; font-weight: 900; color: ${isError ? '#dc2626' : '#059669'}; text-transform: uppercase; letter-spacing: 0.5px;">${title}</div>`,
        html: `<div style="font-size: 13px; font-weight: 600; color: #475569; line-height: 1.6; padding: 5px 15px;">${message}</div>`,
        confirmButtonText: isError ? 'ğŸ”„ ULANGI' : 'âœ… OK',
        confirmButtonColor: isError ? '#dc2626' : '#059669',
        allowOutsideClick: false,
        background: '#ffffff',
        backdrop: 'rgba(0, 0, 0, 0.4)',
        width: '300px',
        customClass: {
          popup: 'swal-compact-professional',
          confirmButton: 'swal-btn-compact'
        }
      });
    }

    /**
     * â³ LOADING STATE HANDLER
     */
    function setLoadingState(isLoading) {
      console.log('â³ Setting loading state:', isLoading);
      const btn = document.getElementById('btnLogin');
      const spinner = document.getElementById('loadingSpinner');
      
      if (!btn) return;
      
      btn.disabled = isLoading;
      btn.innerHTML = isLoading ? 'MEMVERIFIKASI...' : 'MASUK SEKARANG';
      
      if (spinner) spinner.style.display = isLoading ? 'block' : 'none';
    }

    /**
     * ğŸ† SULTAN LOGIN SUCCESS HANDLER
     */
    function handleLoginSuccess(result) {
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('ğŸ“¡ SERVER RESPONSE RECEIVED');
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('Full Result:', JSON.stringify(result, null, 2));
      
      setLoadingState(false);
      isSubmitting = false;

      if (!result) {
        console.error('âŒ Result NULL!');
        showSultanModal('Koneksi Gagal', 'Server tidak merespon. Silakan coba beberapa saat lagi.', 'error');
        return;
      }

      // LOGIN GAGAL
      if (!result.success) {
        console.log('âŒ LOGIN FAILED');
        showSultanModal('Akses Ditolak', result.message || 'Username atau Password salah!', 'error');
        return;
      }

      // âœ… LOGIN SUCCESS
      console.log('âœ…âœ…âœ… LOGIN SUCCESS âœ…âœ…âœ…');

      // Simpan token jika ada
      if (result.token) {
        localStorage.setItem('auth_token', result.token);
      }
      
      const targetUrl = result.redirectUrl || '/';
      console.log('ğŸ¯ Target URL:', targetUrl);

      // TRANSFORMASI FORM MENJADI KARTU OTORISASI
      const loginForm = document.getElementById('loginForm');
      if (loginForm) {
        loginForm.innerHTML = `
          <div style="text-align:center; padding: 30px 20px; border: 4px solid #facc15; border-radius: 3rem; background: #ffffff; animation: zoomIn 0.4s ease; box-shadow: 0 30px 60px rgba(0,0,0,0.15);">
            <div style="color: #059669; font-size: 70px; margin-bottom: 20px;">âœ“</div>
            <strong style="font-size:22px; color: #1e293b; text-transform: uppercase; display:block;">Otorisasi Sah!</strong>
            <p style="font-size:13px; color: #64748b; margin: 10px 0 25px 0; font-weight:600;">Sultan <b>${result.nama || 'User'}</b> Terverifikasi.</p>
            
            <button onclick="window.location.href='${targetUrl}'" 
                    style="width:100%; background: #059669; color: white; padding: 18px; border:none; border-radius: 1.5rem; font-weight: 900; font-size: 11px; text-transform: uppercase; letter-spacing: 2px; cursor:pointer; box-shadow: 0 10px 20px rgba(5, 150, 105, 0.3);">
              MASUK KE DASHBOARD SULTAN
            </button>
          </div>
        `;
      }
      
      // NOTIFIKASI SWEETALERT (PREMIUM LOOK)
      Swal.fire({
        icon: 'success',
        title: '<div style="font-size: 18px; font-weight: 900; color: #059669; letter-spacing:1px;">AKSES DIBUKA</div>',
        html: '<div style="font-size: 13px; font-weight: 600; color: #475569;">Menyiapkan Command Center Sultan...</div>',
        timer: 1500,
        timerProgressBar: true,
        showConfirmButton: false,
        width: '320px',
        customClass: { popup: 'rounded-[2.5rem] border-b-8 border-emerald-500' }
      }).then(() => {
        console.log('ğŸš€ Executing redirect...');
        setTimeout(() => {
          window.location.href = targetUrl;
        }, 300);
      });
    }

    /**
     * ğŸ” SULTAN LOGIN HANDLER (Cloudflare API Version)
     */
    async function handleLogin(event) {
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      console.log('ğŸ” handleLogin() CALLED');
      console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
      
      if (event) {
        event.preventDefault();
        event.stopPropagation();
      }
      
      if (isSubmitting) {
        console.log('âš ï¸ Submitting in progress...');
        return false;
      }
      
      const inputLoginId = document.getElementById('login_id');
      const inputPassword = document.getElementById('password');
      
      const loginId = inputLoginId ? inputLoginId.value.trim() : '';
      const password = inputPassword ? inputPassword.value : '';

      // VALIDASI INPUT
      if (!loginId || !password) {
        showSultanModal('DATA TIDAK LENGKAP', 'Username/Email dan Password wajib diisi!', 'error');
        return false;
      }

      isSubmitting = true;
      setLoadingState(true);

      try {
        console.log('ğŸ“¤ Sending login request to API...');
        
        const response = await fetch(`${API_URL}/api/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            email: loginId,
            password: password 
          })
        });

        console.log('ğŸ“¡ Response status:', response.status);
        
        const result = await response.json();
        console.log('ğŸ“‹ Response data:', result);

        handleLoginSuccess(result);

      } catch (error) {
        console.error('âŒ REQUEST ERROR:', error);
        setLoadingState(false);
        isSubmitting = false;
        showSultanModal('SISTEM SIBUK', 'Koneksi ke server pusat terputus!', 'error');
      }

      return false;
    }

    console.log('âœ… All functions loaded successfully');
  </script>
</body>
</html>
