/* =======================================
   üíª REGISTER.JS - Kanjeng Production
   JavaScript untuk halaman registrasi
======================================= */

// ============================================
// üîß CONFIGURATION
// ============================================
// NOTE: Ini akan diganti dengan environment variables setelah backend ready
var APP_CONFIG = {
  baseUrl: window.location.origin,
  refToken: new URLSearchParams(window.location.search).get('ref') || '',
  clientKey: 'KANJENG_PRODUCTION_2026'
};

// ============================================
// üåê GET REAL IP ADDRESS
// ============================================
async function getRealIPAddress() {
  try {
    const response = await fetch('https://api.ipify.org?format=json');
    const data = await response.json();
    console.log('‚úÖ IP Address Detected:', data.ip);
    return data.ip;
  } catch (e) {
    console.error('‚ùå Failed to get IP:', e);
    // Fallback: Coba API alternatif
    try {
      const response2 = await fetch('https://api.my-ip.io/ip');
      const ip = await response2.text();
      return ip.trim();
    } catch (e2) {
      console.error('‚ùå Fallback IP failed:', e2);
      return 'Unknown IP';
    }
  }
}

// ============================================
// üì° API CALLS - TEMPORARY (GOOGLE APPS SCRIPT)
// TODO: Ganti dengan Worker API setelah backend ready
// ============================================

// GET ACTIVE PRODUCTS
function loadActiveProducts() {
  var productSelect = document.getElementById('bidangUsaha');

  if (productSelect) {
    productSelect.innerHTML = '<option value="">-- MENGHUBUNGKAN PUSAT DATA --</option>';

    // TODO: Ganti dengan fetch ke Worker API
    // fetch('/api/products')
    //   .then(res => res.json())
    //   .then(data => { ... })

    google.script.run
      .withSuccessHandler(function (res) {
        if (res.success && res.data.length > 0) {
          productSelect.innerHTML = '<option value="">-- Pilih Produk --</option>';
          res.data.forEach(function (p) {
            var opt = document.createElement('option');
            opt.value = p.id;
            opt.text = p.usahaId + ': ' + p.nama;
            productSelect.add(opt);
          });
        } else {
          productSelect.innerHTML =
            '<option value="">-- BELUM ADA PRODUK TERSEDIA --</option>';
        }
      })
      .getActiveProducts();
  }
}

// GET SPONSOR INFO
function loadSponsorInfo(token) {
  // TODO: Ganti dengan fetch ke Worker API
  // fetch('/api/sponsor', {
  //   method: 'POST',
  //   body: JSON.stringify({ token })
  // })

  google.script.run
    .withSuccessHandler(function (res) {
      if (res) {
        document.getElementById('sponsorDisplay').innerText = res.sponsorName;
        document.getElementById('referred_by').value = res.sponsorId;

        var logoAtas = document.getElementById('main_admin_logo');
        if (logoAtas) {
          logoAtas.src =
            res.adminPhoto && res.adminPhoto !== ''
              ? res.adminPhoto
              : 'https://ui-avatars.com/api/?name=Admin&background=0f172a&color=fff';
        }

        var avatarSponsor = document.getElementById('admin_avatar');
        if (avatarSponsor) {
          avatarSponsor.src =
            res.sponsorPhoto && res.sponsorPhoto !== ''
              ? res.sponsorPhoto
              : 'https://ui-avatars.com/api/?name=' +
                encodeURIComponent(res.sponsorName) +
                '&background=059669&color=fff';
        }

        console.log('‚úÖ Photo System Synced');
      }
    })
    .getSponsorName(token);
}

// ============================================
// üìç LOCATION SEARCH (OpenStreetMap Nominatim)
// ============================================
var searchInput = document.getElementById('location_search');
var resultsDiv = document.getElementById('search_results');
var searchTimeout = null;

function setupLocationSearch() {
  searchInput.addEventListener('input', function () {
    var query = this.value;
    clearTimeout(searchTimeout);

    if (query.length < 3) {
      resultsDiv.classList.add('hidden');
      return;
    }

    searchTimeout = setTimeout(function () {
      var url =
        'https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&countrycodes=id&q=' +
        encodeURIComponent(query);

      fetch(url)
        .then((res) => res.json())
        .then((data) => {
          resultsDiv.innerHTML = '';
          if (data && data.length > 0) {
            resultsDiv.classList.remove('hidden');
            data.forEach((item) => {
              var div = document.createElement('div');
              div.className =
                'p-3 hover:bg-amber-50 cursor-pointer text-xs border-b border-slate-100';
              div.innerText = item.display_name;
              div.onclick = function () {
                searchInput.value = item.display_name;
                resultsDiv.classList.add('hidden');
                document.getElementById('loc_status').classList.remove('hidden');
                document.getElementById('lat').value = item.lat;
                document.getElementById('lng').value = item.lon;
                document.getElementById('full_addr').value = item.display_name;

                var a = item.address || {};
                document.getElementById('city').value =
                  a.city || a.town || a.city_district || '-';
                document.getElementById('district').value =
                  a.suburb || a.village || a.district || '-';
                document.getElementById('province').value = a.state || '-';
                document.getElementById('country').value = a.country || '-';
                document.getElementById('zip').value = a.postcode || '-';
              };
              resultsDiv.appendChild(div);
            });
          }
        })
        .catch((err) => {
          console.error('Location search error:', err);
        });
    }, 700);
  });
}

// ============================================
// üìù FORM SUBMISSION HANDLER
// ============================================
async function handleFormSubmit(e) {
  e.preventDefault();

  // Validasi lokasi
  if (!document.getElementById('lat').value) {
    return Swal.fire({
      icon: 'warning',
      title: 'Lokasi Belum Valid',
      text: 'Cari domisili Anda dan PILIH dari daftar.',
      confirmButtonColor: '#b8860b'
    });
  }

  var btn = document.getElementById('btnRegister');
  btn.disabled = true;
  btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Mendaftarkan...';

  // GET IP ADDRESS
  console.log('üåê Getting IP Address...');
  const userIP = await getRealIPAddress();
  console.log('‚úÖ User IP:', userIP);

  // PREPARE FORM DATA
  var formData = {
    username: document.getElementById('username').value.trim(),
    nama_user: document.getElementById('nama_user').value.trim(),
    email: document.getElementById('email').value.trim(),
    nomor: document.getElementById('nomor').value.trim(),
    password: document.getElementById('password').value,
    pin: document.getElementById('pin').value.trim(),
    bidangUsahaValue: document.getElementById('bidangUsaha').value,
    referred_by: document.getElementById('referred_by').value,
    locationData: {
      lat: document.getElementById('lat').value,
      lng: document.getElementById('lng').value,
      city: document.getElementById('city').value,
      district: document.getElementById('district').value,
      province: document.getElementById('province').value,
      country: document.getElementById('country').value,
      zip: document.getElementById('zip').value,
      address: document.getElementById('full_addr').value,
      ua: navigator.userAgent,
      ip_address: userIP
    }
  };

  // TODO: Ganti dengan fetch ke Worker API
  // fetch('/api/register-new', {
  //   method: 'POST',
  //   headers: { 'Content-Type': 'application/json' },
  //   body: JSON.stringify(formData)
  // })
  //   .then(res => res.json())
  //   .then(handleRegistrationResponse)
  //   .catch(handleRegistrationError)

  google.script.run
    .withSuccessHandler(function (res) {
      if (res.success) {
        Swal.fire({
          title: 'SUKSES!',
          text: res.message,
          icon: 'success',
          confirmButtonText: 'MASUK LOGIN',
          confirmButtonColor: '#059669'
        }).then(() => {
          window.top.location.href = APP_CONFIG.baseUrl + '/login';
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Gagal',
          text: res.message,
          confirmButtonColor: '#ef4444'
        });
        btn.disabled = false;
        btn.innerHTML = 'DAFTAR SEKARANG';
      }
    })
    .registerNewUserFixed(formData, APP_CONFIG.clientKey);
}

// ============================================
// üöÄ INITIALIZATION
// ============================================
document.addEventListener('DOMContentLoaded', function () {
  console.log('üöÄ Register Page Initialized');

  var rawToken = APP_CONFIG.refToken || '';
  var token = rawToken.trim();

  // Show referral box
  document.getElementById('referralBox').classList.remove('hidden');

  // Load products
  loadActiveProducts();

  // Load sponsor info
  if (token) {
    loadSponsorInfo(token);
  }

  // Setup location search
  setupLocationSearch();

  // Setup form submission
  document.getElementById('registerForm').addEventListener('submit', handleFormSubmit);

  console.log('‚úÖ All systems ready');
});
